<!DOCTYPE HTML>
<html>

<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
body {
  color: white;
  background-color: #222;
}
.app {
  display: flex;
  height: 100vh;
}
.tabs {
  width: 25%;
  min-width: 400px;
  background-color: #333;
  border-right: 1px solid #ccc;
}
.tab {
  padding: 10px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
.tab:hover {
  background-color: #444;
}

.content {
  width: 75%;
  flex: 1;
  padding: 20px;
}

.hidden {
  display: none;
}

h2 {
  margin: 4px;
  padding: 4px;
}

form {
  border: 2px solid rgba(192, 64, 192, 1);
}

label {
  min-width: 125px;
  width: 35%;
  padding: 2px;
  display: inline-block;
  font-weight: bold;
  text-align: left;
}
input[type=text], input[type=password], input[type=email], input[type=search],
    input[type=number] {
  width: 60%;
  float: right;
  line-height: 1.5em;
  border: none;
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
}
button {
  width: 100%;
  background-color: #1e1731;
  color: white;
  border: none;
  font-size: 16pt;
  padding: 8px 16px;
  cursor: pointer;
}
button:hover {
  background-color: #b8b;
  transition: 0.5s;
}
.buttons {
  display: flex;
  justify-content: space-between;
}

#user-responses {
  width: 100%;
  border-collapse: collapse;
}
#user-responses tr {
  border-bottom: 1px solid #eee;
}
#user-responses tr:nth-child(even) td {
  background-color: #555;
}
#user-responses tr:hover td {
  background-color: #eaf;
  color: black;
  transition: 0.5s;
}
#user-responses td {
  padding: 4px;
}

#search-form label {
  width: 20%;
  min-width: auto;
}

#search-map {
  background-color: #eeffee;
  display: flex;
  height: 800px;
}
#search-map {
  color: black;
}

#search-map table {
  font-family: Arial, Helvetica, sans-serif;
  border-collapse: collapse;
  width: 100%;
}
#search-map td {
  border: 1px solid #ddd;
  padding: 8px;
}
#search-map tr:nth-child(even) { background-color: #f2f2f2; }
#search-map tr:hover { background-color: #ddd; }

.search-results {
  width: 25%;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 10px;
}

.result-item {
  cursor: pointer;
  padding: 5px;
  border-bottom: 1px solid #eee;
}

.result-item:hover {
  background-color: #5a7;
}
#map {
  width: 75%;
  height: 800px;
  padding: 0;
}
#manual-bbox-label {
  background-color: #eeccee;
  height: 20px;
  margin: 0;
  padding: 4px;
  padding-right: 8px;
  display: inline-block;
  font-weight: bold;
  cursor: pointer;
}
#manual-bbox-label:hover {
  background-color: #ffaaff;
  transition-duration: 0.4s;
}
#manual-bbox-panel {
  display: none;
  overflow: hidden;
}

.stat-table {
  position: fixed;
  right: 2%;
  background-color: rgba(0, 0, 0, 0.1);
}
.stat-table * {
  background-color: rgba(0, 0, 0, 0.1);
}

.samples {
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;

  height: 50px;
  background-color: #333;
  padding: 0;
  margin: 0;
}
.samples div {
  display: inline-block;
  width: 50px;
  height: 100%;
  margin: 0;
  padding: 0;
  font-size: 10pt;
  background-color: #444;
  cursor: pointer;
  text-align: center;
}
.samples div:hover {
  background-color: #7affd3;
  transition: 0.5s;
}
</style>
</head>
<body>

<div class="app">
  <div class="tabs">
    <div class="tab" onclick="showContent('content-user')">
      <h2>User Management</h2>
      <form id="adduser-form" action="/api/adduser" method="POST">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" value="username" required>
        <br/>
        <label for="password">Password</label>
        <input type="password" id="password" name="password" value="password" required>
        <br/>
        <label for="email">Email</label>
        <input type="email" id="email" name="email" value="username@password.com" required>
        <br/>
        <button type="submit" value="add_user">Add User</button>
      </form>
      <br/>
      <form id="login-form" action="/api/login" method="POST">
        <label for="login-username">Username</label>
        <input type="text" id="login-username" name="username" value="username" required>
        <br/>
        <label for="login-password">Password</label>
        <input type="password" id="login-password" name="password" value="password" required>
        <br/>
        <button type="submit" value="login">Login</button>
      </form>
      <br/>
      <form id="logout-form" action="/api/logout" method="POST">
        <button type="submit" value="logout">Logout</button>
      </form>
    </div>
    <div class="tab" onclick="showContent('content-map')">
      <h2>Map</h2>
      <form id="search-form" action="/api/search" method="POST">
        <div id="manual-bbox">
          <span id="manual-bbox-label" onclick="toggleBBoxPanel()">Map View BBox</span>
          <br/>
          <div id="manual-bbox-panel">
            <label for="search-minlat">minLat</label>
            <input type="number" id="search-minlat" name="minLat" min="-90" max="90" step="0.00000000000000001" value="40.908925">
            <br/>
            <label for="search-maxlat">maxLat</label>
            <input type="number" id="search-maxlat" name="maxLat" min="-90" max="90" step="0.00000000000000001" value="40.927442">
            <br/>
            <label for="search-minlon">minLon</label>
            <input type="number" id="search-minlon" name="minLon" min="-180" max="180" step="0.00000000000000001" value="-73.135909">
            <br/>
            <label for="search-maxlon">maxLon</label>
            <input type="number" id="search-maxlon" name="maxLon" min="-180" max="180" step="0.00000000000000001" value="-73.109216">
          </div>
        </div>
        <br/>
        <label for="onlyInBox">onlyInBox</label>
        <input type="checkbox" id="onlyInBox" name="onlyInBox">
        <input type="search" id="searchTerm" name="searchTerm" value="Stony Brook University" required>
        <button type="submit" value="search">Search</button>
      </form>
    </div>
    <div class="tab" onclick="showContent('content-convert')">
      <h2>Convert</h2>
      <form id="convert-form">
        <label for="convert-minlat">Min Latitude:</label>
        <input type="number" id="convert-minlat" name="minlat" min="-90" max="90" step="0.00000000000000001" value="39">
        <br/>
        <label for="convert-maxlat">Max Latitude:</label>
        <input type="number" id="convert-maxlat" name="maxlat" min="-90" max="90" step="0.00000000000000001" value="47">
        <br/>
        <label for="convert-minlon">Min Longitude:</label>
        <input type="number" id="convert-minlon" name="minlon" min="-180" max="180" step="0.00000000000000001" value="-80">
        <br/>
        <label for="convert-maxlon">Max Longitude:</label>
        <input type="number" id="convert-maxlon" name="maxlon" min="-180" max="180" step="0.00000000000000001" value="-64">
        <br/>
        <label for="convert-minzoom">Min Zoom:</label>
        <input type="number" id="convert-minzoom" name="minzoom" min="0" max="22" value="7">
        <br/>
        <label for="convert-maxzoom">Max Zoom:</label>
        <input type="number" id="convert-maxzoom" name="maxzoom" min="0" max="22" value="22">
        <br/>
        <div class="buttons">
          <button type="submit" value="test-convert-seq">Test Convert Sequential</button>
          <button type="submit" value="test-convert-par">Test Convert Parallel</button>
          <button type="submit" value="test-tiles">Test Tiles</button>
        </div>
      </form>
    </div>
    <div class="tab" onclick="showContent('content-turn')">
      <h2>Turn</h2>
    </div>
  </div>
  <div class="content">
    <div class="content-item hidden" id="content-user">
      <table id="user-responses"></table>
    </div>

    <div class="content-item hidden" id="content-map">
      <div id="search-map">
        <div class="search-results">
          <ul id="results-list"></ul>
        </div> 
        <div id="map"></div>
      </div>
    </div>

    <div class="content-item" id="content-convert">
      <div id="convert-samples" class="samples"></div>
      <div>Pending requests: <span id="requestsRemaining">0</span></div>
      <table id="convert-table" class="stat-table">
        <tr> <th>Statistic</th> <th>Value</th> </tr>
        <tr> <td>N</td> <td></td> </tr>
        <tr> <td>Min</td> <td></td> </tr>
        <tr> <td>Max</td> <td></td> </tr>
        <tr> <td>Average</td> <td></td> </tr>
        <tr> <td>Median</td> <td></td> </tr>
        <tr> <td>90th Percentile</td> <td></td> </tr>
        <tr> <td>95th Percentile</td> <td></td> </tr>
        <tr> <td>99th Percentile</td> <td></td> </tr>
        <tr> <td>Total</td> <td></td> </tr>
      </table>
      <canvas id="convert-chart" width="1000" height="600"></canvas>
    </div>
    <div class="content-item hidden" id="content-turn">
      <img src="/turn/40.916889,-73.117577/40.916602,-73.116295.png"></img>
      <img src="/turn/40.916889,-73.117577/40.915912,-73.11689.png"></img>
      <img src="/turn/40.916889,-73.117577/40.915921,-73.116263.png"></img>
    </div>
  </div>
</div>

<script>
function showContent(tabId) {
  const contentItems = document.getElementsByClassName("content-item");
  for (var i = 0; i < contentItems.length; i++) {
    contentItems[i].classList.add("hidden");
  }
  document.getElementById(tabId).classList.remove("hidden");
}
</script>

<script>
let bboxPanelOn = false;
function toggleBBoxPanel() {
  const label = document.getElementById("manual-bbox-label");
  const panel = document.getElementById("manual-bbox-panel");
  if (bboxPanelOn) {
    panel.style.display = "none";
    label.innerHTML = "Map View BBox";
    bboxPanelOn = false;
  } else {
    panel.style.display = "inline";
    label.innerHTML = "Manual BBox";
    bboxPanelOn = true;
  }
}
</script>

<script>
function add_hook(id) {
  const form = document.getElementById(id);
  form.onsubmit = (event) => {
    event.preventDefault();
    const formData = new FormData(form);
    fetch(form.action, {
      method: 'POST',
      headers: new Headers({ 'content-type': 'application/json' }),
      body: JSON.stringify(Object.fromEntries(formData))
    }).then(async response => {
      const json = await response.json();
      const t = JSON.stringify(json);
      const row = document.getElementById("user-responses").insertRow();
      const labelCell = row.insertCell();
      labelCell.innerHTML = id;
      const responseCell = row.insertCell();
      responseCell.innerHTML = t;

      if (json.message.includes("url=")) {
        const verifyCell = row.insertCell();
        verifyCell.innerHTML = `<a target="_blank" href=${json.message.split("url=")[1]}>Verify</a>`;
      }
    })
    .catch(error => {
      document.getElementById("user-responses-body").innerHTML +=
        `<tr><td>${JSON.stringify(error)}</td></tr>`
    })
  };
}
add_hook("adduser-form");
add_hook("login-form");
add_hook("logout-form");
</script>


<script>
let map = L.map('map').setView([0, 0], 3);

L.tileLayer('/tiles/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
  id: 'base'
}).addTo(map);
let markerGroup = L.layerGroup().addTo(map);

function onMapClick(e) {
  let popup = L.popup();
  console.log(e.latlng);
  popup
      .setLatLng(e.latlng)
      .setContent("You clicked the map at " + e.latlng.toString())
      .openOn(map);
}

map.on('click', onMapClick);
</script>

<script>
function renderResults(results) {
  let resultList = document.getElementById("results-list");
  resultList.innerHTML = ''; // Clear previous results
  
  results.forEach((result, index) => {
    const listItem = document.createElement('li');
    listItem.classList.add('result-item');
    listItem.textContent = result.name;
    listItem.addEventListener('click', () => {
      // Handle onclick event (e.g., display coordinates)
      map.setView(L.latLng(result.coordinates), map.getZoom(), { animation: true });
      console.log('Clicked on:', result.name);
      console.log('Coordinates:', result.coordinates);
    });
    resultList.appendChild(listItem);
  });
}
(() => {
const form = document.getElementById("search-form");
form.onsubmit = (event) => {
  event.preventDefault();
  const formData = new FormData(form);
  let data = Object.fromEntries(formData);
  
  const bbox = bboxPanelOn ?
    {
      minLat: parseFloat(data.minLat),
      maxLat: parseFloat(data.maxLat),
      minLon: parseFloat(data.minLon),
      maxLon: parseFloat(data.maxLon),
    } : {
      minLat: map.getBounds().getNorth(),
      maxLat: map.getBounds().getSouth(),
      minLon: map.getBounds().getWest(),
      maxLon: map.getBounds().getEast(),
    };
  data.bbox = bbox;
  delete data.minLat;
  delete data.maxLat;
  delete data.minLon;
  delete data.maxLon;
  data.onlyInBox = data.onlyInBox == undefined ? false : true;
  console.log(data);

  fetch(form.action, {
    method: 'POST',
    headers: new Headers({ 'content-type': 'application/json' }),
    body: JSON.stringify(data)
  })
  .then(async response => {
    const json = await response.json();
    console.log("JSON is", json);
    let t = JSON.stringify(json);
    let row = `<tr><td>${t}</td></tr>`;
    document.getElementById("user-responses").innerHTML += row;

    renderResults(json);
    markerGroup.clearLayers();

    for (const result of json) {
      L.marker(result.coordinates).addTo(markerGroup)
      .bindPopup(`${result.name}<br/>Lat: ${result.coordinates.lat}<br/>Lon: ${result.coordinates.lon}`);
    }
    if (data.bbox == null) {
      if (json.length == 1) {
        let LL = L.latLng(json[0].coordinates.lat, json[0].coordinates.lon);
        map.setView(LL, map.getZoom(), { animation: true });
      }
    } else {
      L.marker({lat: data.bbox.minLat, lon: data.bbox.minLon}, {icon: L.divIcon({className: 'bbox', html: '<b>⌞</b>'})}).addTo(markerGroup).bindPopup(`BBox NW<br/>Lat: ${data.bbox.minLat}<br/>Lon: ${data.bbox.minLon}`);
      L.marker({lat: data.bbox.minLat, lon: data.bbox.maxLon}, {icon: L.divIcon({className: 'bbox', html: '<b>⌟</b>'})}).addTo(markerGroup).bindPopup(`BBox SE<br/>Lat: ${data.bbox.minLat}<br/>Lon: ${data.bbox.maxLon}`);
      L.marker({lat: data.bbox.maxLat, lon: data.bbox.maxLon}, {icon: L.divIcon({className: 'bbox', html: '<b>⌝</b>'})}).addTo(markerGroup).bindPopup(`BBox NE<br/>Lat: ${data.bbox.maxLat}<br/>Lon: ${data.bbox.maxLon}`);
      L.marker({lat: data.bbox.maxLat, lon: data.bbox.minLon}, {icon: L.divIcon({className: 'bbox', html: '<b>⌜</b>'})}).addTo(markerGroup).bindPopup(`BBox NW<br/>Lat: ${data.bbox.maxLat}<br/>Lon: ${data.bbox.minLon}`);
    }
  }
  )
  .catch(error => {
    console.log(error);
    document.getElementById("user-responses").innerHTML +=
      `<tr><td>ERROR: ${JSON.stringify(error)}</td></tr>`
  })
};
})();
</script>


<script>
async function timeResponses(reqs, endpoint, parallel) {
  const remaining = document.getElementById("requestsRemaining");
  let numRemaining = reqs.length;
  remaining.innerHTML = numRemaining;
  const times = [];
  const start = performance.now();
  if (parallel) {
    await Promise.all(reqs.map(req => (async () => {
        const start = performance.now();
        await fetch(endpoint, {
          method: 'POST',
          headers: new Headers({ 'content-type': 'application/json' }),
          body: JSON.stringify(req)
        });
        times.push(performance.now() - start);
        numRemaining--;
        remaining.innerHTML = numRemaining;
      })()
    ));
  } else {
    for (const req of reqs) {
      const start = performance.now();
      await fetch(endpoint, {
        method: 'POST',
        headers: new Headers({ 'content-type': 'application/json' }),
        body: JSON.stringify(req)
      });
      times.push(performance.now() - start);
      numRemaining--;
      remaining.innerHTML = numRemaining;
    }
  }
  const total = performance.now() - start;
  times.sort((a, b) => a - b);
  return {
    total,
    times
  };
}

function drawPlot(id, times) {
  const n = times.length;
  const percentile = (percent) => times[Math.ceil((percent / 100) * n) - 1];
  const width = 2 * (percentile(75) - percentile(25)) * Math.pow(n, -1/3);

  const rounded = times.map(time => (Math.ceil(time / width) * width).toFixed(2));
  const freqMap = {};
  rounded.forEach(v => freqMap[v] = (freqMap[v] ?? 0) + 1);
  const freq = [];
  Object.entries(freqMap).forEach(([k, v]) => freq.push([parseFloat(k), parseInt(v)]));
  freq.sort((a, b) => a[0] - b[0]);
  const x = freq.map(([bin, freq]) => bin);
  const y = freq.map(([bin, freq]) => freq);

  const getColor = (value) => `hsl(${(value <= 5) ? 120 : (value >= 50 ? 0 : (120 - ((value - 5) / (50 - 5)) * 120))}, 100%, 50%)`;
  
  const ctx = document.getElementById(id).getContext('2d');
  let chartStatus = Chart.getChart("convert-chart");
  if (chartStatus != undefined) {
    chartStatus.destroy();
  }
  const plot = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: x,
        datasets: [{
            label: 'times',
            data: y,
            //backgroundColor: 'rgba(20, 20, 40, 1)',
            backgroundColor: x.map(bin => getColor(bin)),
            //borderColor: x.map(bin => getColor2(bin)),
            //borderWidth: 1
        }]
    },
    options: {
        scales: {
            x: {
              title: {
                display: true,
                text: "Time (ms)",
              },
              beginAtZero: true
            },
            y: {
              beginAtZero: true
            }
        }
    }
  });
}
// times should be sorted
function showStats(id, benchmark) {
  const times = benchmark.times;
  const n = times.length;
  const min = times[0];
  const max = times[n - 1];
  const avg = times.reduce((acc, val) => acc + val, 0) / n;
  const median = n % 2 === 0 ? (times[n / 2 - 1] + times[n / 2]) / 2 : times[Math.floor(n / 2)];
  const percentile = (percent) => times[Math.ceil((percent / 100) * n) - 1];
  const p90 = percentile(90);
  const p95 = percentile(95);
  const p99 = percentile(99);
  document.getElementById(id).innerHTML = `
<tr> <th>Statistic</th> <th>Value</th> </tr>
<tr> <td>N</td> <td>${n}</td> </tr>
<tr> <td>Min</td> <td>${min.toFixed(2)}</td> </tr>
<tr> <td>Max</td> <td>${max.toFixed(2)}</td> </tr>
<tr> <td>Average</td> <td>${avg.toFixed(2)}</td> </tr>
<tr> <td>Median</td> <td>${median.toFixed(2)}</td> </tr>
<tr> <td>90th Percentile</td> <td>${p90.toFixed(2)}</td> </tr>
<tr> <td>95th Percentile</td> <td>${p95.toFixed(2)}</td> </tr>
<tr> <td>99th Percentile</td> <td>${p99.toFixed(2)}</td> </tr>
<tr> <td>Total</td> <td>${benchmark.total.toFixed(2)}</td> </tr>
`;
  }
</script>


<script>
// tests for convert and tiles
const convertTimes = [];
const tileTimes = [];
(() => {
const rand = (l, h) => (Math.random() * (h - l) + l);
function addBenchmark(benchmark, name) {
  drawPlot('convert-chart', benchmark.times);
  showStats('convert-table', benchmark);
  convertTimes.push(benchmark);
  const item = document.createElement("div");
  item.innerHTML = name;
  const i = list.children.length;
  item.addEventListener('click', (event) => {
    drawPlot('convert-chart', convertTimes[i].times);
    showStats('convert-table', convertTimes[i]);
  });
  document.getElementById("convert-samples").appendChild(item);
}
const form = document.getElementById("convert-form");
const list = document.getElementById("convert-samples");
form.onsubmit = async (event) => {
  event.preventDefault();
  const formData = new FormData(form);
  const data = Object.fromEntries(Array.from(formData).map(([k, v]) => [k, Number(v)]));
  console.log("Form data", data);

  if (event.submitter.value == "test-convert-seq") {
    const reqs = []
    for (let i=0; i<1000; i++) {
      reqs.push({
        lat: rand(data.minlat, data.maxlat),
        long: rand(data.minlon, data.maxlon),
        zoom: parseInt(rand(data.minzoom, data.maxzoom)),
      });
    }
    const benchmark = await timeResponses(reqs, "convert", false);
    addBenchmark(benchmark, "1000<br/>Convert<br/>Sequential");
  } else if (event.submitter.value == "test-convert-par") {
    const reqs = []
    for (let i=0; i<1000; i++) {
      reqs.push({
        lat: rand(data.minlat, data.maxlat),
        long: rand(data.minlon, data.maxlon),
        zoom: parseInt(rand(data.minzoom, data.maxzoom)),
      });
    }
    const benchmark = await timeResponses(reqs, "convert", true);
    addBenchmark(benchmark, "1000<br/>Convert<br/>Parallel");
  } else if (event.submitter.value == "test-tiles") {
    const reqs = []
    const start = performance.now();
    const times = [];
    const remaining = document.getElementById("requestsRemaining");
    const n = 1000;
    for (let i=0; i<n; i++) {
      const zoom = parseInt(rand(data.minzoom, data.maxzoom));
      const req = {
        lat: rand(data.minlat, data.maxlat),
        long: rand(data.minlon, data.maxlon),
        zoom
      };
      const resp = await fetch("convert", {
        method: 'POST',
        headers: new Headers({ 'content-type': 'application/json' }),
        body: JSON.stringify(req)
      });
      const json = await resp.json();
      const start = performance.now();
      const tileResp = await fetch(`/tiles/${zoom}/${json.x_tile}/${json.y_tile}.png`, {
        method: 'GET',
      });
      times.push(performance.now() - start);
      
      /*
      const imgBlob = await tileResp.blob();
      const imgObjectURL = URL.createObjectURL(imgBlob);
      const img = document.createElement('img');
      img.src = imgObjectURL;
      document.getElementById("content-convert").append(img);
      */
      remaining.innerHTML = n - i - 1;
    }
    const total = performance.now() - start;
    times.sort((a, b) => a - b);
    addBenchmark({total, times}, `${n}<br/>Tiles`);
  }
};
})();

</script>

</body>
</html>
