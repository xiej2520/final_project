<!DOCTYPE HTML>
<html>

<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body>
  <form id="search-form" action="/search" method="POST">
    <input type="text" id="bbox" name="bbox" value='{"minLat":40.908925,"minLon":-73.135909,"maxLat":40.927442,"maxLon":-73.109216}'>
    <input type="searchTerm" id="searchTerm" name="searchTerm" value="Stony Brook University" required>
    <input type="submit" value="Search">
  </form>
  <form id="convert-form" action="/convert" method="POST">
    <input type="number" id="lat" name="lat" min="-90" max="90" step="0.01" value="40.74">
    <input type="number" id="long" name="long" min="-180" max="180" step="0.01" value="-73.98">
    <input type="number" id="zoom" name="zoom" min="1" max="18" value="9">
    <input type="submit" value="Convert">
  </form>
  <form id="adduser-form" action="/adduser" method="POST">
    <input type="text" id="username" name="username" value="username" required>
    <input type="password" id="password" name="password" value="password" required>
    <input type="email" id="email" name="email" value="username@password.com" required>
    <input type="submit" value="Add User">
  </form>
  <form id="login-form" action="/login" method="POST">
    <input type="text" id="login-username" name="username" value="username" required>
    <input type="password" id="login-password" name="password" value="password" required>
    <input type="submit" value="Login">
  </form>
  <form id="logout-form" action="/logout" method="POST">
    <input type="submit" value="Logout">
  </form>
  <form>
    <input type="radio" id="color" name="style" value="Color" checked />
    <label for="color">Color</label>
    <input type="radio" id="bw" name="style" value="Black and White" />
    <label for="bw">Black and White</label>
  </form>
  <img id="convert-img"/>
  <table>
    <tbody id="responses"></tbody>
  </table>
  <script>
    function add_hook(id) {
      const form = document.getElementById(id);
      form.onsubmit = (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        let data = Object.fromEntries(formData);
        if (data.bbox != null) {
          if (data.bbox != "") {
            data.bbox.replace("\\\"", "\"");
            data.bbox = JSON.parse(data.bbox);
            data.onlyInBox = true;
          } else {
            data.bbox = null;
            data.onlyInBox = false;
          }
        }
        if (data.lat != null) { data.lat = Number(data.lat); }
        if (data.long != null) { data.long = Number(data.long); }
        if (data.zoom != null) { data.zoom = Number(data.zoom); }
        console.log(data);
        fetch(form.action, {
          method: 'POST',
          headers: new Headers({ 'content-type': 'application/json' }),
          body: JSON.stringify(data)
        })
          .then(async response => {
            const json = await response.json();
            console.log(json);
            if (json.x_tile != null) {
              document.getElementById("convert-img").src = `/tiles/${
                document.getElementById("zoom").value
              }/${json.y_tile}/${json.x_tile}.png`;
            }
            let t = JSON.stringify(json);
            let row = `<tr><td>${t}</td>`;

            if (json.message.includes("url=")) {
              row += `<td><a target="_blank" href=${json.message.split("url=")[1]}>Verify</a>
                </td>`;
            }
            row += `</tr>`;
            document.getElementById("responses").innerHTML += row;
          }
          )
          .catch(error => {
            document.getElementById("responses").innerHTML +=
              `<tr><td>${JSON.stringify(error)}</td></tr>`
          }
          )
      };
    }
    add_hook("search-form");
    add_hook("convert-form");
    add_hook("adduser-form");
    add_hook("login-form");
    add_hook("logout-form");
  </script>

  <div id="map"></div>

  <style>
    html,
    body,
    #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script>
    var map = L.map('map').setView([0, 0], 3);

    L.tileLayer('/tiles/{z}/{y}/{x}.png', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
      id: 'base'
    }).addTo(map);
  </script>
</body>

</html>