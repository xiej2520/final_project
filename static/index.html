<!DOCTYPE HTML>
<html>

<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
table {
  font-family: Arial, Helvetica, sans-serif;
  border-collapse: collapse;
  width: 100%;
}
td {
  border: 1px solid #ddd;
  padding: 8px;
}
tr:nth-child(even) { background-color: #f2f2f2; }
tr:hover { background-color: #ddd; }

#search-map {
  background-color: #eeffee;
  display: flex;
  height: 800px;
}

.search-results {
  width: 25%;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 10px;
}

.result-item {
  cursor: pointer;
  padding: 5px;
  border-bottom: 1px solid #eee;
}

.result-item:hover {
  background-color: #f5f5f5;
}

html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}
#map {
  width: 75%;
  height: 800px;
  padding: 0;
}
#manual-bbox {
  background-color: #eeccee;
  padding: 4px;
  height: 20px;
}
#manual-bbox-label {
  margin: 0;
  padding-right: 8px;
  display: inline-block;
  font-weight: bold;
  border-right: 2px solid #333;
  cursor: pointer;
}
#manual-bbox-label:hover {
  background-color: #ffaaff;
  transition-duration: 0.4s;
}
#manual-bbox-panel {
  display: none;
  overflow: hidden;
}
  </style>
</head>

<body>
  <form id="search-form" action="/api/search" method="POST">
    <div id="manual-bbox">
      <span id="manual-bbox-label"  onclick="toggleBBoxPanel()">Map View BBox</span>
      <div id="manual-bbox-panel">
        <label for="search-minlat">minLat</label>
        <input type="number" id="search-minlat" name="minLat" min="-90" max="90" step="0.00000000000000001" value="40.908925">
        <label for="search-maxlat">maxLat</label>
        <input type="number" id="search-maxlat" name="maxLat" min="-90" max="90" step="0.00000000000000001" value="40.927442">
        <label for="search-minlon">minLon</label>
        <input type="number" id="search-minlon" name="minLon" min="-180" max="180" step="0.00000000000000001" value="-73.135909">
        <label for="search-maxlon">maxLon</label>
        <input type="number" id="search-maxlon" name="maxLon" min="-180" max="180" step="0.00000000000000001" value="-73.109216">
      </div>
    </div>
    <label for="onlyInBox">onlyInBox</label>
    <input type="checkbox" id="onlyInBox" name="onlyInBox">
    <input type="searchTerm" id="searchTerm" name="searchTerm" value="Stony Brook University" required>
    <input type="submit" value="Search">
  </form>

<script>
let bboxPanelOn = false;
function toggleBBoxPanel() {
  const label = document.getElementById("manual-bbox-label");
  const panel = document.getElementById("manual-bbox-panel");
  if (bboxPanelOn) {
    panel.style.display = "none";
    label.innerHTML = "Map View BBox";
    bboxPanelOn = false;
  } else {
    panel.style.display = "inline";
    label.innerHTML = "Manual BBox";
    bboxPanelOn = true;
  }
}
</script>

  <div id="search-map">
    <div class="search-results">
      <ul id="results-list"></ul>
    </div> 
    <div id="map"></div>
  </div>

  <script>
    var map = L.map('map').setView([0, 0], 3);

    L.tileLayer('/tiles/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
      id: 'base'
    }).addTo(map);
    var markerGroup = L.layerGroup().addTo(map);

    function onMapClick(e) {
      var popup = L.popup();
      console.log(e.latlng);
      popup
          .setLatLng(e.latlng)
          .setContent("You clicked the map at " + e.latlng.toString())
          .openOn(map);
    }

    map.on('click', onMapClick);
  </script>

  <form id="convert-form" action="/convert" method="POST">
    <input type="number" id="lat" name="lat" min="-90" max="90" step="0.00000000000000001" value="40.74">
    <input type="number" id="long" name="long" min="-180" max="180" step="0.00000000000000001" value="-73.98">
    <input type="number" id="zoom" name="zoom" min="1" max="18" value="9">
    <input type="submit" value="Convert">
  </form>
  <table>
    <tbody id="responses"></tbody>
  </table>
  <script>
function renderResults(results) {
  let resultList = document.getElementById("results-list");
  resultList.innerHTML = ''; // Clear previous results
  
  results.forEach((result, index) => {
    const listItem = document.createElement('li');
    listItem.classList.add('result-item');
    listItem.textContent = result.name;
    listItem.addEventListener('click', () => {
      // Handle onclick event (e.g., display coordinates)
      map.setView(L.latLng(result.coordinates), map.getZoom(), { animation: true });
      console.log('Clicked on:', result.name);
      console.log('Coordinates:', result.coordinates);
    });
    resultList.appendChild(listItem);
  });
}
(() => {
const form = document.getElementById("search-form");
form.onsubmit = (event) => {
  event.preventDefault();
  const formData = new FormData(form);
  let data = Object.fromEntries(formData);
  
  const bbox = bboxPanelOn ?
    {
      minLat: parseFloat(data.minLat),
      maxLat: parseFloat(data.maxLat),
      minLon: parseFloat(data.minLon),
      maxLon: parseFloat(data.maxLon),
    } : {
      minLat: map.getBounds().getNorth(),
      maxLat: map.getBounds().getSouth(),
      minLon: map.getBounds().getWest(),
      maxLon: map.getBounds().getEast(),
    };
  data.bbox = bbox;
  delete data.minLat;
  delete data.maxLat;
  delete data.minLon;
  delete data.maxLon;
  data.onlyInBox = data.onlyInBox == undefined ? false : true;
  console.log(data);

  fetch(form.action, {
    method: 'POST',
    headers: new Headers({ 'content-type': 'application/json' }),
    body: JSON.stringify(data)
  })
  .then(async response => {
    const json = await response.json();
    console.log("JSON is", json);
    let t = JSON.stringify(json);
    let row = `<tr><td>${t}</td></tr>`;
    document.getElementById("responses").innerHTML += row;

    renderResults(json);
    markerGroup.clearLayers();

    for (const result of json) {
      L.marker(result.coordinates).addTo(markerGroup)
      .bindPopup(`${result.name}<br/>Lat: ${result.coordinates.lat}<br/>Lon: ${result.coordinates.lon}`);
    }
    if (data.bbox == null) {
      if (json.length == 1) {
        let LL = L.latLng(json[0].coordinates.lat, json[0].coordinates.lon);
        map.setView(LL, map.getZoom(), { animation: true });
      }
    } else {
      L.marker({lat: data.bbox.minLat, lon: data.bbox.minLon}, {icon: L.divIcon({className: 'bbox', html: '<b>⌞</b>'})}).addTo(markerGroup).bindPopup(`BBox NW<br/>Lat: ${data.bbox.minLat}<br/>Lon: ${data.bbox.minLon}`);
      L.marker({lat: data.bbox.minLat, lon: data.bbox.maxLon}, {icon: L.divIcon({className: 'bbox', html: '<b>⌟</b>'})}).addTo(markerGroup).bindPopup(`BBox SE<br/>Lat: ${data.bbox.minLat}<br/>Lon: ${data.bbox.maxLon}`);
      L.marker({lat: data.bbox.maxLat, lon: data.bbox.maxLon}, {icon: L.divIcon({className: 'bbox', html: '<b>⌝</b>'})}).addTo(markerGroup).bindPopup(`BBox NE<br/>Lat: ${data.bbox.maxLat}<br/>Lon: ${data.bbox.maxLon}`);
      L.marker({lat: data.bbox.maxLat, lon: data.bbox.minLon}, {icon: L.divIcon({className: 'bbox', html: '<b>⌜</b>'})}).addTo(markerGroup).bindPopup(`BBox NW<br/>Lat: ${data.bbox.maxLat}<br/>Lon: ${data.bbox.minLon}`);
    }
  }
  )
  .catch(error => {
    console.log(error);
    document.getElementById("responses").innerHTML +=
      `<tr><td>ERROR: ${JSON.stringify(error)}</td></tr>`
  })
};
})();
  </script>

  <script>
(() => {
const form = document.getElementById("convert-form");
form.onsubmit = (event) => {
  event.preventDefault();
  const formData = new FormData(form);
  let data = Object.fromEntries(formData);
  data.lat = Number(data.lat);
  data.long = Number(data.long);
  data.zoom = Number(data.zoom);
  console.log(data);
  fetch(form.action, {
    method: 'POST',
    headers: new Headers({ 'content-type': 'application/json' }),
    body: JSON.stringify(data)
  })
  .then(async response => {
    const json = await response.json();
    console.log(json);
    let t = JSON.stringify(json);
    let row = `<tr><td>${t}<br/>zoom=${data.zoom}</td><td><img src="/tiles/${data.zoom}/${json.x_tile}/${json.y_tile}.png" width="256" height="256"/></td></tr>`;
    document.getElementById("responses").innerHTML += row;
  }
  )
  .catch(error => {
    console.log(error);
    document.getElementById("responses").innerHTML +=
      `<tr><td>ERROR: ${JSON.stringify(error)}</td></tr>`
  })
};
})();
  </script>

</body>

</html>