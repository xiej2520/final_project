<!DOCTYPE HTML>
<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.4.2/openseadragon.min.js"></script>
  

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body>
  <form id="adduser-form" action="/adduser" method="POST">
    <input type="text" id="username" name="username" value="username" required>
    <input type="password" id="password" name="password" value="password" required>
    <input type="email" id="email" name="email" value="username@password.com" required>
    <input type="submit" value="Add User">
  </form>
  <form id="login-form" action="/login" method="POST">
    <input type="text" id="login-username" name="username" value="username" required>
    <input type="password" id="login-password" name="password" value="password" required>
    <input type="submit" value="Login">
  </form>
  <form id="logout-form" action="/logout" method="POST">
    <input type="submit" value="Logout">
  </form>
  <div id="wp2" style="width: 800px; height: 600px;">
  </div>
  <form>
    <input type="radio" id="color" name="style" value="Color" checked />
    <label for="color">Color</label>
    <input type="radio" id="bw" name="style" value="Black and White" />
    <label for="bw">Black and White</label>
  </form>
  <script type="text/javascript">
    let viewer = OpenSeadragon({
      id: "wp2",
      prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.4.2/images/",
      navigatorSizeRatio: 0.25,
      tileSources: {
        height: 84683,
        width: 84683,
        tileSize: 512,
        minLevel: 1,
        maxLevel: 8,
        getTileUrl: function (level, x, y) {
          let button = document.querySelector('input[name="style"]:checked') || "color";
          return `/tiles/l${level}/${y + 1}/${x + 1}.png`;
        }
      }
    });

    document.querySelectorAll('input[name="style"]').forEach((radio) =>
      radio.addEventListener('change',
        () => {
          //let point = viewer.viewport.getBounds().getCenter();
          //let zoom = viewer.viewport.getZoom();
          viewer.close();
          viewer.world.resetItems(); // idk if necessary
          viewer.world.removeAll();  // or this
          viewer.open({
            height: 84683,
            width: 84683,
            tileSize: 512,
            minLevel: 1,
            maxLevel: 8,
            getTileUrl: function (level, x, y) {
              let button = document.querySelector('input[name="style"]:checked') || "color";
              return `/tiles/l${level}/${y + 1}/${x + 1}.png`;
            }
          });
          //viewer.viewport.panTo(point);
          //viewer.viewport.zoomTo(zoom);
        }
      ))
  </script>
  <table>
    <tbody id="responses"></tbody>
  </table>
  <script>
    function add_hook(id) {
      const form = document.getElementById(id);
      form.onsubmit = (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        fetch(form.action, {
          method: 'POST',
          headers: new Headers({ 'content-type': 'application/json' }),
          body: JSON.stringify(Object.fromEntries(formData))
        })
          .then(async response => {
            const json = await response.json();
            let t = JSON.stringify(json);
            let row = `<tr><td>${t}</td>`;

            if (json.message.includes("url=")) {
              row += `<td><a target="_blank" href=${json.message.split("url=")[1]}>Verify</a>
                </td>`;
            }
            row += `</tr>`;
            document.getElementById("responses").innerHTML += row;
          }
          )
          .catch(error => {
            document.getElementById("responses").innerHTML +=
              `<tr><td>${JSON.stringify(error)}</td></tr>`
          }
          )
      };
    }
    add_hook("adduser-form");
    add_hook("login-form");
    add_hook("logout-form");
  </script>

  <div id="map"></div>

  <style>
    html,
    body,
    #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script>
    var map = L.map('map').setView([0, 0], 3);

    L.tileLayer('/tiles/l{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
      id: 'base'
    }).addTo(map);
  </script>
</body>

</html>